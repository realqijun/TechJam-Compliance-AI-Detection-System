<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Compliance Analysis Results</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
    <style>
      body { font-family: "Roboto", sans-serif; }
      .dataframe th, .dataframe td {
        border: 1px solid #e2e8f0;
        padding: 12px;
        text-align: left;
        max-width: 280px;
        overflow-wrap: break-word;
        vertical-align: top;
      }
      .dataframe th {
        background-color: #f1f5f9;
        font-weight: 600;
        text-transform: uppercase;
        color: #1f2937;
      }
      .dataframe tbody tr:nth-child(even) { background-color: #f8fafc; }
      .clickable-cell { cursor: pointer; transition: background-color 0.2s; }
      .clickable-cell:hover { background-color: #e2e8f0; }

      /* === Row states === */
      .needs-review th, .needs-review td { background-color: #FEF3C7 !important; } /* yellow */
      .approved th, .approved td { background-color: #DCFCE7 !important; } /* green */
      .required-flag th, .required-flag td { background-color: #FEE2E2 !important; } /* red */

      /* Prettier checkboxes */
      .review-checkbox {
        appearance: none; -webkit-appearance: none;
        width: 1.5rem; height: 1.5rem;
        border: 2px solid #9CA3AF; border-radius: 0.375rem;
        display: inline-block; position: relative; cursor: pointer;
        transition: all 0.2s ease;
      }
      .review-checkbox:hover {
        border-color: #2563EB; box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
      }
      .review-checkbox:checked {
        background-color: #2563EB; border-color: #2563EB;
      }
      .review-checkbox:checked::after {
        content: "✔"; position: absolute; inset: 0;
        color: white; font-size: 1rem; font-weight: bold;
        display: flex; align-items: center; justify-content: center;
      }
    </style>
  </head>
  <body class="bg-gradient-to-br from-gray-50 to-gray-200 flex flex-col items-center p-6 min-h-screen">

    <div id="loadingOverlay"
        class="fixed inset-0 bg-gray-900 bg-opacity-60 hidden z-50
            flex flex-col items-center justify-center">
      <div class="w-16 h-16 border-4 border-blue-400 border-t-transparent
              rounded-full animate-spin"></div>
      <p class="text-white text-lg mt-4 font-semibold">Preparing download…</p>
    </div>

    <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-6xl border border-gray-100">
      <div class="flex items-center gap-3 mb-8">
        <h1 class="text-4xl font-extrabold text-gray-900 tracking-tight flex-1">Analysis Results</h1>
        <a href="/?tab=upload"
          class="px-5 py-3 text-lg font-semibold text-white bg-blue-600 rounded-full shadow-lg hover:bg-blue-700 transition-colors duration-200">
          ← Upload CSV
        </a>
        <a href="/?tab=single"
          class="px-5 py-3 text-lg font-semibold text-white bg-emerald-600 rounded-full shadow-lg hover:bg-emerald-700 transition-colors duration-200">
          Single Feature →
        </a>
      </div>

      <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-md">
        {{ table_data | safe }}
      </div>

      <div class="flex justify-center mt-8">
        <button id="downloadCsvBtn"
          class="px-6 py-3 text-lg font-semibold text-blue-600 bg-white rounded-full shadow-lg border-2 border-blue-600 hover:bg-blue-50 transition-colors duration-200">
          Download CSV
        </button>
      </div>
    </div>

    <!-- Side Panel for editing reasoning -->
    <div id="fullContentPanel"
      class="fixed right-0 top-0 h-full w-0 bg-white shadow-xl z-50 overflow-y-auto transform translate-x-full transition-transform duration-300 ease-in-out p-6">
      <div class="flex justify-between items-center pb-4 border-b border-gray-200">
        <h2 class="text-2xl font-bold text-gray-800">Edit Reasoning</h2>
        <button id="closePanelBtn" class="text-gray-500 hover:text-gray-700 focus:outline-none">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <textarea id="reasonEditor"
        class="w-full h-48 border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-blue-500 focus:outline-none mt-4"></textarea>
      <div class="flex items-center justify-end gap-2 mt-4">
        <button id="cancelEdit" class="px-4 py-2 rounded-full bg-gray-200 text-gray-800">Cancel</button>
        <button id="saveEdit" class="px-4 py-2 rounded-full bg-blue-600 text-white">Save</button>
      </div>
    </div>

    <!-- Loading Icon -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const overlay = document.getElementById('loadingOverlay');
        const downloadBtn = document.getElementById('downloadCsvBtn');
        if (downloadBtn) {
          downloadBtn.addEventListener('click', () => {
            overlay.classList.remove('hidden');
          });
        }
      });
    </script>

    <script>
      const panel = document.getElementById('fullContentPanel');
      const reasonEditor = document.getElementById('reasonEditor');
      const closeBtn = document.getElementById('closePanelBtn');
      const table = document.querySelector('.dataframe');
      const downloadBtn = document.getElementById('downloadCsvBtn');
      let currentCell = null;

      // Helpers
      function truncateText(text, maxLength) {
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
      }
      function escapeCsv(text) {
        if (text.includes(',') || text.includes('"') || text.includes('\n')) return '"' + text.replace(/"/g, '""') + '"';
        return text;
      }
      function norm(s) { return (s || '').toLowerCase().replace(/[^a-z0-9]/g, ''); }
      function getHeaderIndexFuzzy(key) {
        if (!table) return -1;
        const headers = table.querySelectorAll('thead th');
        const k = norm(key);
        for (let i = 0; i < headers.length; i++) {
          const h = norm(headers[i].textContent.trim());
          if (h.includes(k)) return i;
        }
        return -1;
      }
      function firstNumber(text) {
        const m = (text || '').match(/-?\d+(?:\.\d+)?/);
        return m ? parseFloat(m[0]) : NaN;
      }
      function addBadge(cell, text, classes) {
        const badge = document.createElement('span');
        badge.className = 'inline-block ml-2 text-xs font-semibold px-2 py-0.5 rounded-full ' + classes;
        badge.textContent = text;
        cell.appendChild(badge);
      }

      document.addEventListener('DOMContentLoaded', () => {
        if (!table) return;

        // Find columns
        let confIdx = getHeaderIndexFuzzy('confidence_score');
        if (confIdx === -1) confIdx = getHeaderIndexFuzzy('confidence score');
        if (confIdx === -1) confIdx = getHeaderIndexFuzzy('confidence');
        let reasoningIdx = getHeaderIndexFuzzy('reasoning');
        let flagIdx = getHeaderIndexFuzzy('compliance_flag');

        const headerRow = table.querySelector('thead tr');
        if (headerRow) {
          const th = document.createElement('th');
          th.textContent = "REVIEWED";
          headerRow.appendChild(th);
        }

        const rows = table.querySelectorAll('tbody tr');
        rows.forEach((row) => {
          const cells = row.querySelectorAll('th, td');
          const firstCell = cells[0];

          // Initial state
          const flagText = flagIdx >= 0 ? (cells[flagIdx].textContent || '').trim().toUpperCase() : '';
          const conf = confIdx >= 0 ? firstNumber(cells[confIdx].textContent) : NaN;

          if (flagText === 'REQUIRED') {
            row.classList.add('required-flag', 'ring-2', 'ring-red-300');
            addBadge(firstCell, 'REQUIRED', 'bg-red-500 text-white');
          } else if (isNaN(conf) || conf < 0.6) {
            row.classList.add('needs-review', 'ring-2', 'ring-amber-400');
            addBadge(firstCell, 'NEEDS REVIEW', 'bg-amber-500 text-white');
          }

          if (reasoningIdx >= 0 && reasoningIdx < cells.length) {
            const c = cells[reasoningIdx];
            const originalText = c.textContent.trim();
            c.classList.add('clickable-cell');
            c.dataset.fullText = originalText;
            if (originalText.length > 100) c.textContent = truncateText(originalText, 100);
          }

          // Checkbox column
          const reviewCell = document.createElement('td');
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.className = 'review-checkbox';
          reviewCell.appendChild(checkbox);
          row.appendChild(reviewCell);

          // Checkbox handler
          checkbox.addEventListener('change', () => {
            row.classList.remove('needs-review', 'approved', 'required-flag',
                                 'ring-amber-400', 'ring-emerald-300', 'ring-red-300');

            if (checkbox.checked) {
              // ✅ turn row green
              row.classList.add('approved', 'ring-2', 'ring-emerald-300');
            } else {
              // ❌ restore original state
              if (flagText === 'REQUIRED') {
                row.classList.add('required-flag', 'ring-2', 'ring-red-300');
              } else if (isNaN(conf) || conf < 0.6) {
                row.classList.add('needs-review', 'ring-2', 'ring-amber-400');
              }
            }
          });
        });

        // Editing panel
        table.addEventListener('click', (event) => {
          const cell = event.target.closest('td, th');
          if (!cell || !cell.classList.contains('clickable-cell')) return;
          currentCell = cell;
          reasonEditor.value = cell.dataset.fullText || cell.textContent.trim();
          panel.style.width = '420px';
          panel.style.transform = 'translateX(0)';
        });
      });

      // Panel controls
      document.getElementById('cancelEdit').addEventListener('click', () => {
        panel.style.transform = 'translateX(100%)';
      });
      document.getElementById('saveEdit').addEventListener('click', () => {
        if (!currentCell) return;
        const newText = reasonEditor.value.trim();
        currentCell.dataset.fullText = newText;
        currentCell.textContent = newText.length > 100 ? newText.slice(0, 100) + '...' : newText;
        panel.style.transform = 'translateX(100%)';
      });
      document.getElementById('closePanelBtn').addEventListener('click', () => {
        panel.style.transform = 'translateX(100%)';
      });
      document.addEventListener('click', (event) => {
        if (!panel.contains(event.target) && !table.contains(event.target) && panel.style.transform === 'translateX(0px)') {
          panel.style.transform = 'translateX(100%)';
        }
      });

      // Download CSV
      downloadBtn.addEventListener('click', () => {
        const rows = document.querySelectorAll('.dataframe tr');
        let csv = [];
        const headerCells = rows[0].querySelectorAll('th');
        let headers = Array.from(headerCells).map(th => escapeCsv(th.textContent.trim()));
        csv.push(headers.join(','));

        for (let i = 1; i < rows.length; i++) {
          const row = rows[i];
          const cells = row.querySelectorAll('th, td');
          let rowData = [];
          cells.forEach((cell) => {
            const cb = cell.querySelector('input[type=checkbox]');
            if (cb) {
              rowData.push(cb.checked ? '✔' : '');
            } else if (cell.classList.contains('clickable-cell')) {
              rowData.push(escapeCsv(cell.dataset.fullText || cell.textContent.trim()));
            } else {
              rowData.push(escapeCsv(cell.textContent.trim()));
            }
          });
          csv.push(rowData.join(','));
        }

        const csvString = csv.join('\n');
        const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.setAttribute('download', 'compliance_analysis_results.csv');
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      });
    </script>
  </body>
</html>
